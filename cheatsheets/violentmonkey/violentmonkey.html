<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Violentmonkey é€ŸæŸ¥è¡¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Violentmonkey (æš´åŠ›çŒ´) è„šæœ¬å¼€å‘é€ŸæŸ¥è¡¨ï¼Œæ¶µç›–å…ƒæ•°æ®å—ã€GM_APIã€DOMè§‚å¯ŸåŠç°ä»£è¯­æ³•ã€‚">
    <meta name="keywords" content="Violentmonkey, Userscript, GM_API, JavaScript, Tampermonkey">
    <link rel="stylesheet" href="../../assets/variables.css">
    <link rel="stylesheet" href="../../assets/global.css">
    <link rel="stylesheet" href="../../assets/cheatsheet.css">
    <link rel="stylesheet" href="../../assets/prism-tomorrow.min.css">
    <link rel="icon" type="image/png" href="../../assets/brand/cheatsheet.png" />
</head>
<body>

<div class="container">
    <!-- Header / Controls -->
    <div class="panel">
        <span class="title">Violentmonkey é€ŸæŸ¥è¡¨</span>
        <label for="columnWidth">ğŸ“ åˆ†æ å®½åº¦:</label>
        <input type="range" id="columnWidth" class="slider-bar" min="300" max="660" value="400">
        <span id="widthVal" class="slider-val">400px</span>
    </div>

    <!-- Main Content -->
    <div class="cheat-columns" id="columns">

        <!-- 1. å…ƒæ•°æ®å— (Metadata) -->
        <div class="card">
            <h2>å…ƒæ•°æ®å— (Metadata Block) <a href="https://violentmonkey.github.io/api/metadata-block/" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <p>è„šæœ¬å¤´éƒ¨é…ç½®ï¼Œå®šä¹‰åŸºæœ¬ä¿¡æ¯ã€æƒé™å’Œè¿è¡Œè§„åˆ™ã€‚</p>
            <pre><code class="language-javascript">// ==UserScript==
// @name            Script Name
// @namespace       https://example.com
// @version         1.0.0
// @description     Description
// @author          Author
// @match           *://google.com/*
// @grant           GM_setValue
// @grant           GM_xmlhttpRequest
// @require         https://cdn.js/jquery.min.js
// @run-at          document-end
// @connect         api.example.com
// ==/UserScript==</code></pre>
            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@name</td><td style="color:#ccc;">è„šæœ¬åç§°</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@namespace</td><td style="color:#ccc;">å”¯ä¸€æ ‡è¯†ç¬¦</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@match</td><td style="color:#ccc;">åŒ¹é…è§„åˆ™ (æ¨è)</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@grant</td><td style="color:#ccc;">ç”³è¯·æƒé™</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@require</td><td style="color:#ccc;">å¼•å…¥JSåº“</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@run-at</td><td style="color:#ccc;">æ‰§è¡Œæ—¶æœº</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">@connect</td><td style="color:#ccc;">å…è®¸è·¨åŸŸåŸŸå</td></tr>
            </table>
        </div>

        <!-- 2. æ‰§è¡Œæ—¶æœºä¸åŒ¹é… -->
        <div class="card">
            <h2>æ‰§è¡Œæ—¶æœº (@run-at)</h2>
            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <tr><td style="color:#a5d6ff; padding: 3px 0;">document-start</td><td style="color:#ccc;">æ–‡æ¡£å¼€å§‹åŠ è½½</td></tr>
                <tr><td style="color:#a5d6ff; padding: 3px 0;">document-body</td><td style="color:#ccc;">&lt;body&gt;å‡ºç°æ—¶</td></tr>
                <tr><td style="color:#a5d6ff; padding: 3px 0;">document-end</td><td style="color:#ccc;">DOMå®Œæˆ (é»˜è®¤)</td></tr>
                <tr><td style="color:#a5d6ff; padding: 3px 0;">document-idle</td><td style="color:#ccc;">é¡µé¢å®Œå…¨åŠ è½½</td></tr>
            </table>
            <h3 style="margin-top: 12px;">åŒ¹é…è§„åˆ™</h3>
            <pre><code class="language-javascript">// @match *://*/*           // æ‰€æœ‰ http/https
// @match https://google.com/*
// @include /https:\/\/.*\.com\/.*/  // æ­£åˆ™
// @exclude https://*/login</code></pre>
        </div>

        <!-- 3. æ•°æ®å­˜å‚¨ -->
        <div class="card">
            <h2>æ•°æ®å­˜å‚¨ (Storage) <a href="https://violentmonkey.github.io/api/gm/" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <p>éœ€ <code>@grant GM_setValue</code> ç­‰ã€‚</p>
            <pre><code class="language-javascript">// å­˜å‚¨ï¼ˆæ”¯æŒä»»æ„ç±»å‹ï¼‰
GM_setValue('config', { theme: 'dark' });

// è¯»å–ï¼ˆæ”¯æŒé»˜è®¤å€¼ï¼‰
const conf = GM_getValue('config', {});

// åˆ é™¤
GM_deleteValue('config');

// åˆ—å‡ºæ‰€æœ‰é”®
const keys = GM_listValues();

// ç›‘å¬å˜åŒ–ï¼ˆè·¨æ ‡ç­¾é¡µï¼‰
GM_addValueChangeListener('key', (n, o, v, r) => {
  console.log('Changed:', v);
});</code></pre>
        </div>

        <!-- 4. ç½‘ç»œè¯·æ±‚ -->
        <div class="card">
            <h2>ç½‘ç»œè¯·æ±‚ (XHR) <a href="https://violentmonkey.github.io/api/gm/#gm_xmlhttprequest" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <p>è·¨åŸŸè¯·æ±‚éœ€ <code>@grant GM_xmlhttpRequest</code> å’Œ <code>@connect</code>ã€‚</p>
            <pre><code class="language-javascript">GM_xmlhttpRequest({
  method: 'GET',
  url: 'https://api.example.com/data',
  headers: {
    'Authorization': 'Bearer token'
  },
  onload: (res) => {
    if (res.status === 200) {
      console.log(res.responseText);
    }
  },
  onerror: (err) => console.error(err),
  ontimeout: () => console.error('è¶…æ—¶')
});</code></pre>
        </div>

        <!-- 5. æ ·å¼ä¸èµ„æº -->
        <div class="card">
            <h2>æ ·å¼ä¸èµ„æº <a href="https://violentmonkey.github.io/api/gm/#gm_addstyle" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <h3>æ³¨å…¥ CSS</h3>
            <pre><code class="language-javascript">GM_addStyle(`
  #my-panel {
    position: fixed;
    top: 10px; right: 10px;
    z-index: 99999;
  }
`);</code></pre>
            <h3>ä½¿ç”¨å¤–éƒ¨èµ„æº</h3>
            <pre><code class="language-javascript">// @resource myCSS https://site.com/s.css
const css = GM_getResourceText('myCSS');
GM_addStyle(css);

// @resource icon https://site.com/icon.png
const iconUrl = GM_getResourceURL('icon');
// è¿”å› base64 æ•°æ® URL</code></pre>
        </div>

        <!-- 6. ç•Œé¢äº¤äº’ -->
        <div class="card">
            <h2>ç•Œé¢äº¤äº’ (UI) <a href="https://violentmonkey.github.io/api/gm/#gm_registermenucommand" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <h3>èœå•å‘½ä»¤</h3>
            <pre><code class="language-javascript">GM_registerMenuCommand('âš™ï¸ è®¾ç½®', () => {
  toggleSettings();
}, 's'); // å¿«æ·é”®</code></pre>
            <h3>é€šçŸ¥ä¸å‰ªè´´æ¿</h3>
            <pre><code class="language-javascript">// æ¡Œé¢é€šçŸ¥
GM_notification({
  text: 'ä»»åŠ¡å®Œæˆ',
  title: 'æç¤º',
  onclick: () => console.log('ç‚¹å‡»')
});

// å†™å…¥å‰ªè´´æ¿
GM_setClipboard('æ–‡æœ¬å†…å®¹');

// æ–°æ ‡ç­¾é¡µæ‰“å¼€
GM_openInTab(url, { active: false });</code></pre>
        </div>

        <!-- 7. DOM è§‚å¯Ÿ -->
        <div class="card">
            <h2>DOM è§‚å¯Ÿ <a href="https://violentmonkey.github.io/guide/observing-dom/" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <p>SPA å¿…å¤‡ï¼Œç›‘å¬åŠ¨æ€åŠ è½½å…ƒç´ ã€‚</p>
            <pre><code class="language-javascript">const obs = new MutationObserver(muts => {
  for (const m of muts) {
    for (const node of m.addedNodes) {
      if (node.nodeType === 1 &&
          node.matches('.ad-banner')) {
        node.remove();
      }
    }
  }
});

obs.observe(document.body, {
  childList: true,
  subtree: true
});</code></pre>
        </div>

        <!-- 8. å®ç”¨ç‰‡æ®µ -->
        <div class="card">
            <h2>å®ç”¨ç‰‡æ®µ (Snippets)</h2>
            <h3>ç­‰å¾…å…ƒç´ </h3>
            <pre><code class="language-javascript">function waitFor(selector, timeout = 10000) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(selector)) {
      return resolve(document.querySelector(selector));
    }
    const observer = new MutationObserver(() => {
      const el = document.querySelector(selector);
      if (el) {
        observer.disconnect();
        resolve(el);
      }
    });
    observer.observe(document.body, {
      childList: true, subtree: true
    });
    setTimeout(() => {
      observer.disconnect();
      reject(new Error('Timeout'));
    }, timeout);
  });
}

// await waitFor('.btn');</code></pre>
        </div>

        <!-- 9. é˜²æŠ–èŠ‚æµ -->
        <div class="card">
            <h2>é˜²æŠ–ä¸èŠ‚æµ</h2>
            <h3>é˜²æŠ– (debounce)</h3>
            <pre><code class="language-javascript">function debounce(fn, delay = 300) {
  let timer = null;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}</code></pre>
            <h3>èŠ‚æµ (throttle)</h3>
            <pre><code class="language-javascript">function throttle(fn, interval = 300) {
  let lastTime = 0;
  return function(...args) {
    const now = Date.now();
    if (now - lastTime >= interval) {
      lastTime = now;
      fn.apply(this, args);
    }
  };
}</code></pre>
        </div>

        <!-- 10. ç°ä»£ API -->
        <div class="card">
            <h2>ç°ä»£ API (GM.*) <a href="https://violentmonkey.github.io/guide/using-modern-syntax/" target="_blank" style="float:right; text-decoration:none; opacity:0.5;">#</a></h2>
            <p>Greasemonkey 4+ é£æ ¼çš„å¼‚æ­¥ APIã€‚</p>
            <pre><code class="language-javascript">(async () => {
  // æ•°æ®å­˜å‚¨
  await GM.setValue('key', 123);
  const val = await GM.getValue('key');
  await GM.deleteValue('key');
  const keys = await GM.listValues();
  
  // ç½‘ç»œè¯·æ±‚ï¼ˆå›è°ƒæ–¹å¼ä¸å˜ï¼‰
  GM.xmlHttpRequest({
    url: '...',
    onload: res => console.log(res)
  });
})();</code></pre>
            <table style="width:100%; border-collapse: collapse; font-size: 13px; margin-top: 8px;">
                <tr><td style="color:#a5d6ff; padding: 2px 0;">GM.setValue</td><td style="color:#ccc;">å¼‚æ­¥å­˜å‚¨</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">GM.getValue</td><td style="color:#ccc;">å¼‚æ­¥è¯»å–</td></tr>
                <tr><td style="color:#a5d6ff; padding: 2px 0;">GM.xmlHttpRequest</td><td style="color:#ccc;">ç½‘ç»œè¯·æ±‚</td></tr>
            </table>
        </div>

        <!-- 11. è°ƒè¯•æŠ€å·§ -->
        <div class="card">
            <h2>è°ƒè¯•æŠ€å·§</h2>
            <h3>unsafeWindow</h3>
            <pre><code class="language-javascript">// è®¿é—®é¡µé¢åŸç”Ÿ window
unsafeWindow.nativeFunction();

// æš´éœ²è°ƒè¯•å˜é‡
unsafeWindow.myDebug = { config, data };</code></pre>
            <h3>é”™è¯¯æ•è·</h3>
            <pre><code class="language-javascript">// å…¨å±€é”™è¯¯
window.addEventListener('error', (e) => {
  console.error('[Script]', e.error);
});

// Promise é”™è¯¯
window.addEventListener('unhandledrejection', (e) => {
  console.error('[Script]', e.reason);
});</code></pre>
        </div>

        <!-- 12. å®Œæ•´ç¤ºä¾‹ -->
        <div class="card">
            <h2>å®Œæ•´ç¤ºä¾‹</h2>
            <p>è‡ªåŠ¨æš—é»‘æ¨¡å¼è„šæœ¬</p>
            <pre><code class="language-javascript">// ==UserScript==
// @name         æš—é»‘æ¨¡å¼
// @match        https://example.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_registerMenuCommand
// @grant        GM_addStyle
// ==/UserScript==

(function() {
  const KEY = 'darkEnabled';
  let enabled = GM_getValue(KEY, true);
  
  function apply() {
    if (enabled) {
      GM_addStyle(`body {
        background: #1a1a1a !important;
        color: #e0e0e0 !important;
      }`);
    }
  }
  
  GM_registerMenuCommand('ğŸŒ™ åˆ‡æ¢', () => {
    enabled = !enabled;
    GM_setValue(KEY, enabled);
    location.reload();
  });
  
  apply();
})();</code></pre>
        </div>

    </div>
</div>

<script src="../../assets/common.js"></script>
<script src="../../assets/prism.js"></script>
<script src="../../assets/prism-autoloader.min.js"></script>
</body>
</html>
